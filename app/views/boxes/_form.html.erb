<%= form_with(model: box, local: true, html: { multipart: true }) do |form| %>
  <% if box.errors.any? %>
    <div class="alert error">
      <h2><%= pluralize(box.errors.count, "error") %> prohibited this box from being saved:</h2>
      <ul>
        <% box.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :display_name %>
    <%= form.text_field :display_name %>
  </div>

  <div>
    <%= form.label :contents %>
    <%= form.text_area :contents %>
  </div>

  <div>
    <%= form.label :box_group_ids, "Groups" %>
    <%= form.collection_check_boxes :box_group_ids, BoxGroup.all, :id, :display_name do |b| %>
      <div>
        <%= b.check_box %> <%= b.label %>
      </div>
    <% end %>
  </div>

  <% if box.persisted? && box.images.any? %>
    <div>
      <label>Current Images</label>
      <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        <% box.images.each do |image| %>
          <div id="image-<%= image.id %>" style="position: relative; display: inline-block;">
            <%= image_tag image_path(image), alt: "Box Image", style: "max-width: 150px; max-height: 150px; display: block;" %>
            <button type="button" onclick="markImageForDeletion(<%= image.id %>)" style="position: absolute; top: 0; right: 0; background: rgba(255,0,0,0.8); color: white; border: none; padding: 5px 10px; cursor: pointer; font-size: 20px; line-height: 1;">Ã—</button>
          </div>
        <% end %>
      </div>
    </div>

    <script>
      function markImageForDeletion(imageId) {
        const container = document.getElementById('image-' + imageId);
        container.style.display = 'none';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'box[remove_image_ids][]';
        input.value = imageId;
        container.parentNode.appendChild(input);
      }
    </script>
  <% end %>

  <div>
    <%= form.label :uploaded_images, "Upload Images" %>
    <%= form.file_field :uploaded_images, multiple: true %>
  </div>

  <div>
    <%= form.submit %>
  </div>
<% end %>